# Some of these are used throughout my dashboard

# weather
- trigger:
    - platform: time_pattern
      minutes: /15
    - platform: homeassistant
      event: start      
  action:
    - service: weather.get_forecasts
      target:
        entity_id: weather.forecast_nilsen_goberg
      data:
        type: daily
      response_variable: daily_forecast
    - service: weather.get_forecasts
      target:
        entity_id: weather.forecast_nilsen_goberg
      data:
        type: hourly
      response_variable: hourly_forecast
  sensor:
    - name: Weather Forecast
      unique_id: weather_forecast_combined
      state: "{{ now().isoformat() }}"
      attributes:
        current: >
          {% set current = hourly_forecast['weather.forecast_nilsen_goberg'].forecast[0] %}
          {% from 'weather_translate.jinja' import translate_condition %}
          {% set t = current.temperature | float %}
          {% set k = (current.wind_speed | float) / 3.6 %}
          {% set v = (k/1000*60*60) %}
          {% set a = 13.12 + 0.6215*t - 11.37*(v**0.16) + 0.3965*t*(v**0.16) %}
          {% set direction = ['N','NNÃ˜','NÃ˜','Ã˜NÃ˜','Ã˜','Ã˜SÃ˜','SÃ˜','SSÃ˜','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (current.wind_bearing | float) %}
          {% from 'weather_wind.jinja' import get_wind_description %}
          {% set weather = current.condition %}
          {
            "condition": "{{ translate_condition(weather) | trim }}",
            "icon": "{% if is_state('sun.sun', 'above_horizon') %}{{ '/local/ic/weather_icons/met/' + weather + '.png' }}{% else %}{{ '/local/ic/weather_icons/met/' + weather + '_night.png' }}{% endif %}",         
            "temperature": {{ current.temperature }},
            "wind_speed": {{ (current.wind_speed | float / 3.6) | round(1) }},
            "wind_gust_speed": {{ current.wind_gust_speed }},
            "wind_bearing": {{ current.wind_bearing }},
            "wind_dir": "{{ direction[((degree+11.25)/22.5)|int] }}",
            "wind_desc": "{{ get_wind_description(current.wind_speed | float) | trim | replace('\n', '') }}",
            "precipitation": {{ current.precipitation }},
            "precipitation_probability": {{ current.precipitation_probability }},
            "humidity": {{ current.humidity }},
            "cloud_coverage": {{ current.cloud_coverage }},
            "feels_like": {{ a | round(1) }}
            {% if current.uv_index is defined and current.uv_index is not none %},
            "uv_index": {{ current.uv_index }}
            {% endif %}
          }

        today: >
          {% set today = daily_forecast['weather.forecast_nilsen_goberg'].forecast[0] %}
          {% from 'weather_translate.jinja' import translate_condition %}
          {% set t = today.temperature | float %}
          {% set k = (today.wind_speed | float) / 3.6 %}
          {% set v = (k/1000*60*60) %}
          {% set a = 13.12 + 0.6215*t - 11.37*(v**0.16) + 0.3965*t*(v**0.16) %}
          {% set direction = ['N','NNÃ˜','NÃ˜','Ã˜NÃ˜','Ã˜','Ã˜SÃ˜','SÃ˜','SSÃ˜','S','SSV','SV','VSV','V','VNV','NV','NNV','N'] %}
          {% set degree = (today.wind_bearing | float) %}
          {% from 'weather_wind.jinja' import get_wind_description %}
          {% set weather = today.condition %}
          {
            "condition": "{{ translate_condition(weather) | trim }}",
            "icon": "{{ '/local/ic/weather_icons/met/' + weather + '.png' }}",
            "temperature": {{ today.temperature }},
            "templow": {{ today.templow }},
            "wind_speed": {{ (today.wind_speed | float / 3.6) | round(1) }},
            "wind_gust_speed": {{ today.wind_gust_speed }},
            "wind_bearing": {{ today.wind_bearing }},
            "wind_dir": "{{ direction[((degree+11.25)/22.5)|int] }}",
            "wind_desc": "{{ get_wind_description(today.wind_speed | float) | trim | replace('\n', '') }}",
            "precipitation": {{ today.precipitation }},
            "precipitation_probability": {{ today.precipitation_probability }},
            "humidity": {{ today.humidity }},
            "feels_like": {{ a | round(1) }}
            {% if today.uv_index is defined and today.uv_index is not none %},
            "uv_index": {{ today.uv_index }}
            {% endif %}
          }

        forecast: >
          [
            {% for i in range(1, 6) %}
              {% set day = daily_forecast['weather.forecast_nilsen_goberg'].forecast[i] %}
              {% from 'weather_translate.jinja' import translate_condition %}
              {% from 'weather_wind.jinja' import get_wind_description %}
              {% set weather = day.condition %}
              {
                "datetime": "{{ day.datetime }}",
                "condition": "{{ translate_condition(weather) | trim }}",
                "icon": "{{ '/local/ic/weather_icons/met/' + weather + '.png' }}",
                "temperature": {{ day.temperature }}
                {% if day.precipitation is defined and day.precipitation is not none %},
                "precipitation": {{ day.precipitation }}
                {% endif %}
                {% if day.wind_speed is defined and day.wind_speed is not none %},
                "wind_speed": {{ (day.wind_speed | float / 3.6) | round(1) }},
                "wind_desc": "{{ get_wind_description(day.wind_speed | float) | trim | replace('\n', '') }}"
                {% endif %}
                {% if day.uv_index is defined and day.uv_index is not none %},
                "uv_index": {{ day.uv_index }}
                {% endif %}
              }{{ "," if not loop.last else "" }}
            {% endfor %}
          ]
        hourly: >
          [
            {% for i in range(1, hourly_forecast['weather.forecast_nilsen_goberg'].forecast | length) %}
              {% set hour = hourly_forecast['weather.forecast_nilsen_goberg'].forecast[i] %}
              {% set weather = hour.condition %}
              {
                "datetime": "{{ hour.datetime }}",
                "icon": "{% set is_day = hour.datetime.split('T')[1].split(':')[0] | int > 6 and hour.datetime.split('T')[1].split(':')[0] | int < 20 %}{% if is_day %}{{ '/local/ic/weather_icons/met/' + weather + '.png' }}{% else %}{{ '/local/ic/weather_icons/met/' + weather + '_night.png' }}{% endif %}",
                "temperature": {{ hour.temperature }},
                "wind_speed": {{ (hour.wind_speed | float / 3.6) | round(1) }}
                {% if hour.precipitation is defined and hour.precipitation is not none %},
                "precipitation": {{ hour.precipitation }}
                {% endif %}
              }{{ "," if not loop.last else "" }}
            {% endfor %}
          ]

# calendar
- trigger:
    - platform: time_pattern
      hours: /1
    - platform: homeassistant
      event: start      
  action:
    - action: calendar.get_events
      target:
        entity_id:
          - calendar.manchester_united
          - calendar.Sarah_og_Ted
          - calendar.f1_race
      data:
        duration:
          days: 60
      response_variable: scheduled_events_privat
  sensor:
    - name: Calendar Upcoming Events
      unique_id: calendar_upcoming_events
      state: >
        {{ scheduled_events_privat['calendar.manchester_united'].events | count() +
           scheduled_events_privat['calendar.Sarah_og_Ted'].events | count() +
           scheduled_events_privat['calendar.f1_race'].events | count() }}
      attributes:
        events: >
          {{ (scheduled_events_privat['calendar.manchester_united'].events +
              scheduled_events_privat['calendar.Sarah_og_Ted'].events + 
              scheduled_events_privat['calendar.f1_race'].events) 
              | sort(attribute='start') 
              | replace('Manchester United', 'Man United') 
              | replace('Tottenham Hotspur', 'Tottenham')               
              | replace('Brighton & Hove Albion FC', 'Brighton') 
              | replace('Brentford FC', 'Brentford') 
              | replace('West Ham United', 'West Ham') 
              | replace('Leicester City', 'Leicester') 
              | replace('Nottingham Forest', 'Nottingham') 
              | replace('AFC Bournemouth', 'Bournemouth') 
              | replace('Wolverhampton Wanderers', 'Wolves') 
              | replace('Newcastle United', 'Newcastle') 
              | replace('Manchester City', 'Man City') 
              | replace(': Race (', ': ') 
              | replace(')', ' ðŸŽï¸') 
          }}
      icon: mdi:calendar
- trigger:
    - platform: time_pattern
      hours: /1
    - platform: homeassistant
      event: start      
  action:
    - action: calendar.get_events
      target:
        entity_id:
          - calendar.manchester_united
          - calendar.Sarah_og_Ted
          - calendar.f1_race
      data:
        start_date_time: "{{ now().strftime('%Y-%m-%d') }} 00:00:00"
        end_date_time: "{{ now().strftime('%Y-%m-%d') }} 23:59:59"
      response_variable: scheduled_events_privat_today
  sensor:
    - name: Calendar Upcoming Events
      unique_id: calendar_upcoming_events_today
      state: >
        {{ scheduled_events_privat_today['calendar.manchester_united'].events | count() +
           scheduled_events_privat_today['calendar.Sarah_og_Ted'].events | count() +
           scheduled_events_privat_today['calendar.f1_race'].events | count() }}
      attributes:
        events: >
          {{ (scheduled_events_privat_today['calendar.manchester_united'].events +
              scheduled_events_privat_today['calendar.Sarah_og_Ted'].events + 
              scheduled_events_privat_today['calendar.f1_race'].events) 
              | sort(attribute='start') 
              | replace('Manchester United', 'Man United') 
              | replace('Tottenham Hotspur', 'Tottenham')               
              | replace('Brighton & Hove Albion FC', 'Brighton') 
              | replace('Brentford FC', 'Brentford') 
              | replace('West Ham United', 'West Ham') 
              | replace('Leicester City', 'Leicester') 
              | replace('Nottingham Forest', 'Nottingham') 
              | replace('AFC Bournemouth', 'Bournemouth') 
              | replace('Wolverhampton Wanderers', 'Wolves') 
              | replace('Newcastle United', 'Newcastle') 
              | replace('Manchester City', 'Man City') 
              | replace(': Race (', ': ') 
              | replace(')', '') 
          }}
      icon: mdi:calendar

# todos
- trigger:
    - platform: state
      entity_id:
        - todo.gjoremal
        - todo.sma_oppgaver
    - platform: homeassistant
      event: start
    - platform: time_pattern
      minutes: "/10"
  action:
    - service: todo.get_items
      target:
        entity_id:
          - todo.gjoremal
          - todo.sma_oppgaver
      response_variable: tasks
  sensor:
    - name: "Todo Oppgaver Count"
      unique_id: todo_oppgaver_count
      # I set the state to the total count of pending tasks, which is usually more useful than "tmp"
      state: >
        {{ 
          (tasks['todo.sma_oppgaver']['items'] | selectattr('status', 'eq', 'needs_action') | list | count) + 
          (tasks['todo.gjoremal']['items'] | selectattr('status', 'eq', 'needs_action') | list | count)
        }}
      attributes:
        sma_oppgaver_completed: >
          {{ tasks['todo.sma_oppgaver']['items'] | selectattr('status', 'eq', 'completed') | list | count }}
        sma_oppgaver_pending: >
          {{ tasks['todo.sma_oppgaver']['items'] | selectattr('status', 'eq', 'needs_action') | list | count }}
        store_oppgaver_completed: >
          {{ tasks['todo.gjoremal']['items'] | selectattr('status', 'eq', 'completed') | list | count }}
        store_oppgaver_pending: >
          {{ tasks['todo.gjoremal']['items'] | selectattr('status', 'eq', 'needs_action') | list | count }}
      icon: mdi:clipboard-check-outline

# Lights
- sensor:
  - name: "Lights on"
    unique_id: "lights_on"
    state: >
      {% set lights = [
        states.light.bathroomup_light_cabinet,
        states.light.bathroomup_light_ceiling,
        states.light.livingroom_light_ceiling_left,
        states.light.livingroom_light_ceiling_right,
        states.switch.livingroom_powerstrip_sofa_l3,
        states.light.livingroom_light_bystairs,
        states.light.livingroom_plug_under_trapp,
        states.light.kitchen_light_dimmer_left,
        states.light.kitchen_light_dimmer_right,
        states.light.hallway_light_ceiling_2,
        states.light.upstairs_light_ceilingstairs_dimmerdown,
        states.light.upstairs_light_ceiling,
        states.light.upstairs_plug_desklamp,
        states.light.upstairs_light_nightlight,
        states.light.bathroomdown_light_ceiling,
        states.light.bedroom_light_ceiling,
        states.light.bedroom_light_bed,
        states.light.bedroom_light_Ted,
        states.light.bedroom_light_Sarah,
        states.light.Tina_light_ceiling,
        states.light.Anna_light_ceiling,
        states.light.outdoor_light_carport
        ] %}
      {{ lights | selectattr('state','eq','on') | list | count }}    

# batteries
- sensor:
    - name: "Battery low alert"
      unique_id: battery_low_alert
      state: >
        {{ states.sensor
            | selectattr('entity_id', 'search', '_battery_plus$')
            | map(attribute='state')
            | map('float', default=101)
            | select('lt', 40)
            | list | count > 0 }}
      icon: mdi:battery-check-outline
      attributes:
        low_battery_entities: >
          {% set matching_sensors = states.sensor | selectattr('entity_id', 'search', '_battery_plus$') %}
          {% set intermediate_data = namespace(items=[]) %}
          {% for sensor in matching_sensors %}
            {% set state_val = sensor.state | float(none) %}
            {% if state_val is not none %}
              {% set intermediate_data.items = intermediate_data.items + [{'id': sensor.entity_id, 'val': state_val}] %}
            {% endif %}
          {% endfor %}
          {{ intermediate_data.items | selectattr('val', 'lt', 40) | map(attribute='id') | list }}      

# Trash
- sensor:
  - name: "Neste tÃ¸mming"
    unique_id: "neste_tomming2"
    state: >
      {% set garbage_types = {
        'sensor.restavfall': "Restavfall",
        'sensor.papp_og_papir': "Papir & Papp",
        'sensor.plastemballasje': "Plastavfall",
        'sensor.glass_og_metallemballasje': "Glass & Metall"
      } %}
      {% set pickup_days = namespace(min=999, types=[]) %}
      {% for sensor, garbage_type in garbage_types.items() %}
        {% set days = state_attr(sensor, 'days_to_pickup') | int %}
        {% if days < pickup_days.min %}
          {% set pickup_days.min = days %}
          {% set pickup_days.types = [garbage_type] %}
        {% elif days == pickup_days.min %}
          {% set pickup_days.types = pickup_days.types + [garbage_type] %}
        {% endif %}
      {% endfor %}
      {% set types_string = pickup_days.types | join(' og ') if pickup_days.types | length > 1 else pickup_days.types[0] %}
      {{ pickup_days.min }},{{ types_string }}  

# Date and time
- sensor:
  - name: "Tid"
    state: >
      {{ now().strftime('%H') }}:{{ now().strftime('%M')}}
    attributes:
      hh: "{{ now().strftime('%H') }}"
      mm: "{{ now().strftime('%M')}}"
      greeting: >
        {% set hour = now().hour %}
        {% if hour >= 5 and hour < 12 %}
          God morgen!
        {% elif hour >= 12 and hour < 17 %}
          God ettermiddag!
        {% elif hour >= 17 and hour < 23 %}
          God kveld!
        {% else %}
          God natt!
        {% endif %}      
- sensor:
  - name: "Dato"
    state: >
      {% set months = ['Januar', 'Februar', 'Mars', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Desember'] %} {{ now().day | string + '. ' + months[now().month-1]}}
- sensor:
  - name: "Maned"
    state: >
      {% set months = ['Januar', 'Februar', 'Mars', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Desember'] %} {{ months[now().month-1]}}
- sensor:
  - name: "Dag"
    state: >
      {{ ['Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'LÃ¸rdag', 'SÃ¸ndag'][now().weekday()] }}
- sensor:
  - name: "Ukedagag"
    state: >
      {{ now().weekday() }}     

# Washer/Dishwasher
- sensor:
  - name: "Dishwasher states"
    unique_id: "dishwasher_states"
    state: ok
    attributes:
      run_state: >
        {{ state_attr('sensor.oppvaskmaskin', 'run_state') | replace('@DW_STATE_', '') | replace('_W', '') | capitalize }}
      current_course: >
        {{ state_attr('sensor.oppvaskmaskin', 'current_course') | replace('@DW_COURSE_', '') | replace('_W', '') | capitalize }}
- sensor:
  - name: "Washing Remain Percent"
    unique_id: "washing_percent"
    state: > 
      {% if state_attr('sensor.vaskemaskin', 'remain_time') == '0:00:00' %}
        0
      {% elif state_attr('sensor.vaskemaskin', 'remain_time') == state_attr('sensor.vaskemaskin', 'initial_time') %}
        100
      {% else %}
        {% set initial = state_attr('sensor.vaskemaskin', 'initial_time').split(':') %}
        {% set remain = state_attr('sensor.vaskemaskin', 'remain_time').split(':') %}
        {% set initial_seconds = initial[0] | int * 3600 + initial[1] | int * 60 + initial[2] | int %}
        {% set remain_seconds = remain[0] | int * 3600 + remain[1] | int * 60 + remain[2] | int %}
        {% set percentage_remaining = (remain_seconds / initial_seconds) * 100 %}
        {{ percentage_remaining | round }}
      {% endif %}
- sensor:
  - name: "Dishwashing Remain Percent"
    unique_id: "dishwashing_percent"
    state: > 
      {% if state_attr('sensor.oppvaskmaskin', 'remain_time') == '0:00:00' %}
        0
      {% elif state_attr('sensor.oppvaskmaskin', 'remain_time') == state_attr('sensor.oppvaskmaskin', 'initial_time') %}
        100
      {% else %}
        {% set initial = state_attr('sensor.oppvaskmaskin', 'initial_time').split(':') %}
        {% set remain = state_attr('sensor.oppvaskmaskin', 'remain_time').split(':') %}
        {% set initial_seconds = initial[0] | int * 3600 + initial[1] | int * 60 + initial[2] | int %}
        {% set remain_seconds = remain[0] | int * 3600 + remain[1] | int * 60 + remain[2] | int %}
        {% set percentage_remaining = (remain_seconds / initial_seconds) * 100 %}
        {{ percentage_remaining | round }}
      {% endif %}

# Rolf
- sensor:
  - name: "Rolf arbeidstid"
    unique_id: "rolf_arbeidstid"
    state: >
        {% set total_seconds = states('sensor.rolf_total_cleaning_time')|int %}
        {% set hours = total_seconds // 3600 %}
        {% set minutes = (total_seconds % 3600) // 60 %}
        {% set seconds = total_seconds % 60 %}
        {{ "{:02}:{:02}:{:02}".format(hours, minutes, seconds) }}
- sensor:
  - default_entity_id: sensor.rolf_all
    state: '{{ states.input_boolean.rolf_rom_gang.state == ''on'' or states.input_boolean.rolf_rom_kjokken.state
      == ''on'' or states.input_boolean.rolf_rom_trapp.state == ''on'' or states.input_boolean.rolf_rom_stue.state
      == ''on'' or states.input_boolean.rolf_rom_bad.state == ''on'' }}'
    name: rolf_all

# Car
- sensor:
  - name: "Ioniq Custom"
    unique_id: "ioniq_custom"
    state: Yo
    attributes:
      ladetid_hours: >
        {% set battery_level = states('sensor.ioniq_5_ev_battery_level_2') | float %}
        {% set soc = states('number.ioniq_5_ac_charging_limit_2') | round() %}
        {{ ((soc - battery_level) * 72.6 / 100 / 4.1) | round() }}  
      ladetid: >
        {% set charge_needed = max(0, (states('number.ioniq_5_ac_charging_limit_2') | float | round - states('sensor.ioniq_5_ev_battery_level_2') | float)) %}
        {% set total_seconds = (charge_needed * 72.6 / 100 / 4.1) * 60 * 60 %}
        {% set h = (total_seconds / 3600) | int %}
        {% set m = ((total_seconds % 3600) / 60) | int %}
        {% set s = (total_seconds % 60) | int %}
        [{{ h }}, {{ m }}, {{ s }}]
      ladepris: >
        {% set battery_level = states('sensor.ioniq_5_ev_battery_level_2') | float %}
        {% set soc = states('number.ioniq_5_ac_charging_limit_2') | round(0) | float %}
        {% set pris = states('sensor.strompris_inkl_avgifter_v2') | float %}
        {% set charge_needed = (soc - battery_level)/100 %}
        {{ (pris * (charge_needed if charge_needed > 0 else 0)*72.6) | round(0) }}
- sensor:
  - default_entity_id: sensor.ioniq_ladepris
    name: Ioniq 5 ladepris
    state: '{% set battery_level = states(''sensor.ioniq_5_ev_battery_level'') | float
      %} {% set soc = states(''input_number.ioniq_5_soc'') | round(0) %} {% set pris
      = states(''sensor.strompris_inkl_avgifter_v2'') %} {{ pris | multiply(((soc
      - battery_level)/100)*72.6) | round(1) }}'
- sensor:
  - default_entity_id: sensor.ioniq_ladepris_dum
    name: Ioniq 5 ladepris dum
    state: '{% set pris = states(''sensor.strompris_inkl_avgifter_v2'') | float %}
      {{ (pris*72.6) | round(1) }}'

# Electricity
- sensor:
    - name: "Norgespris Pris nÃ¥"
      unique_id: norgespris_current_price
      unit_of_measurement: "kr/kWh"
      state: >
        {% set norgespris = 0.5 %}
        {% set nettleie_day = 0.4315 %}
        {% set nettleie_night_weekend = 0.3315 %}
        
        {% if now().isoweekday() >= 6 %}
          {# Weekend #}
          {{ (norgespris + nettleie_night_weekend) | round(4) }}
        {% else %}
          {# Weekday #}
          {% if now().hour >= 6 and now().hour < 22 %}
            {# Day #}
            {{ (norgespris + nettleie_day) | round(4) }}
          {% else %}
            {# Night #}
            {{ (norgespris + nettleie_night_weekend) | round(4) }}
          {% endif %}
        {% endif %}

      attributes:
        today: >
          {% set ns = namespace(data=[]) %}

          {% set norgespris = 0.5 %}
          {% set nettleie_day = 0.4315 %}
          {% set nettleie_night_weekend = 0.3315 %}
          {% set price_day = (norgespris + nettleie_day) | round(4) %}
          {% set price_night_weekend = (norgespris + nettleie_night_weekend) | round(4) %}

          {% set today_start = now().replace(hour=0, minute=0, second=0, microsecond=0) %}

          {% for hour in range(24) %}
            {% set start_time = today_start + timedelta(hours=hour) %}
            {% set end_time = start_time + timedelta(hours=1) %}
            
            {% set current_price = 0 %}
            {% if start_time.isoweekday() >= 6 %}
              {% set current_price = price_night_weekend %}
            {% else %}
              {% if start_time.hour >= 6 and start_time.hour < 22 %}
                {% set current_price = price_day %}
              {% else %}
                {% set current_price = price_night_weekend %}
              {% endif %}
            {% endif %}

            {# Modify the 'data' attribute of the namespace object #}
            {% set ns.data = ns.data + [{
              'start': start_time.isoformat(),
              'end': end_time.isoformat(),
              'value': current_price
            }] %}
          {% endfor %}
          {# Output the final list from the namespace #}
          {{ ns.data }}

        tomorrow: >
          {% set ns = namespace(data=[]) %}

          {% set norgespris = 0.5 %}
          {% set nettleie_day = 0.4315 %}
          {% set nettleie_night_weekend = 0.3315 %}
          {% set price_day = (norgespris + nettleie_day) | round(4) %}
          {% set price_night_weekend = (norgespris + nettleie_night_weekend) | round(4) %}

          {% set tomorrow_start = now().replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(days=1) %}
          
          {% for hour in range(24) %}
            {% set start_time = tomorrow_start + timedelta(hours=hour) %}
            {% set end_time = start_time + timedelta(hours=1) %}
            
            {% set current_price = 0 %}
            {% if start_time.isoweekday() >= 6 %}
              {% set current_price = price_night_weekend %}
            {% else %}
              {% if start_time.hour >= 6 and start_time.hour < 22 %}
                {% set current_price = price_day %}
              {% else %}
                {% set current_price = price_night_weekend %}
              {% endif %}
            {% endif %}

            {# Modify the 'data' attribute of the namespace object #}
            {% set ns.data = ns.data + [{
              'start': start_time.isoformat(),
              'end': end_time.isoformat(),
              'value': current_price
            }] %}
          {% endfor %}
          {# Output the final list from the namespace #}
          {{ ns.data }} 
- sensor:
    - name: "Nettleie pris nÃ¥"
      unique_id: nettleie_current_price
      unit_of_measurement: "kr/kWh"
      state: >
        {% set nettleie_day = 0.4315 %}
        {% set nettleie_night_weekend = 0.3315 %}
        
        {% if now().isoweekday() >= 6 %}
          {# Weekend #}
          {{ (nettleie_night_weekend) | round(4) }}
        {% else %}
          {# Weekday #}
          {% if now().hour >= 6 and now().hour < 22 %}
            {# Day #}
            {{ (nettleie_day) | round(4) }}
          {% else %}
            {# Night #}
            {{ (nettleie_night_weekend) | round(4) }}
          {% endif %}
        {% endif %}          
- sensor:
    - name: "Stromregning Estimate"
      unique_id: stromregning_estimate
      unit_of_measurement: "kr"
      state: |
        {% set norgespris = states('sensor.amsleser_tpi_monthly_energy_cost_2') | float %}
        {% set solgt = states('sensor.amsleser_po_monthly_energy_cost') | float %}
        {% set fastledd = states('sensor.energy_level_price') | float %}
        {{ (norgespris + fastledd + 39 - solgt) | round(2) }}
      attributes:
        strom: |
          {% set norgespris = states('sensor.amsleser_tpi_monthly_energy_cost_2') | float %}
          {% set nettleie = states('sensor.amsleser_tpi_monthly_energy_cost_4') | float %}
          {{ (norgespris - nettleie) | round(2) }}
        nettleie: |
          {{ (states('sensor.amsleser_tpi_monthly_energy_cost_4') | float) | round(2) }}
        spotpris: |
          {{ (states('sensor.amsleser_tpi_monthly_energy_cost_3') | float) | round(2) }}
        regning: |
          {% set spotpris = states('sensor.amsleser_tpi_monthly_energy_cost_3') | float %}
          {% set fastledd = states('sensor.energy_level_price') | float %}
          {% set solgt = states('sensor.amsleser_po_monthly_energy_cost') | float %}
          {{ (spotpris + fastledd + 39 - solgt) | round(2) }}     
        solgtfor: |
          {{ (states('sensor.amsleser_po_monthly_energy_cost') | float) | round(2) }}

- sensor:
  - unit_of_measurement: kr
    default_entity_id: sensor.strom_kostnad_tv
    name: StrÃ¸m Kostnad TV
    state: '{{ (states(''sensor.norgespris_pris_na'') | float) | multiply(0.15)
      | round(2) }}'
- sensor:
  - unit_of_measurement: kr
    default_entity_id: sensor.strom_kostnad_oppvaskmaskin
    name: StrÃ¸m Kostnad Oppvaskmaskin
    state: '{{ (states(''sensor.norgespris_pris_na'') | float) | multiply(1.5)
      | round(2) }}'
- sensor:
  - unit_of_measurement: kr
    default_entity_id: sensor.strom_kostnad_vaskemaskin
    name: StrÃ¸m Kostnad Vaskemaskin
    state: '{{ (states(''sensor.norgespris_pris_na'') | float) | multiply(1)
      | round(2) }}'
- sensor:
  - unit_of_measurement: kr
    default_entity_id: sensor.strom_kostnad_torketrommel
    name: StrÃ¸m Kostnad TÃ¸rketrommel
    state: '{{ (states(''sensor.norgespris_pris_na'') | float) | multiply(4)
      | round(2) }}'
- sensor:
  - unit_of_measurement: kr
    default_entity_id: sensor.strom_kostnad_dusj
    name: StrÃ¸m Kostnad Dusj
    state: '{{ (states(''sensor.norgespris_pris_na'') | float) | multiply(5.6)
      | round(2) }}'

# Dashboard helpers
- sensor:
    - name: "Dashboard Active Card"
      unique_id: dashboard_active_card
      icon: mdi:view-dashboard
      state: >
        {% if is_state('sensor.ovn_machine_state', 'running') %}
          oven
        {% elif is_state('vacuum.rolf', 'cleaning') %}
          vacuum
        {% elif is_state('sensor.oppvaskmaskin', 'on') %}
          dishwasher
        {% elif is_state('sensor.vaskemaskin', 'on') %}
          washing_machine
        {% elif is_state('media_player.tv_stue', 'on') %}
          tv
        {% else %}
          vacuum
        {% endif %}
- sensor:
    - name: "Dashboard index"
      unique_id: dashboard_index
      state: Index
      attributes:
        events: >
          {% set events = state_attr('sensor.calendar_upcoming_events', 'events') %}
          {% set count = events | selectattr('start', 'match',
          now().strftime('%Y-%m-%d')) | list | length %} {{ "ingen" if count == 0
          else count }} {{ "avtale" if count == 1 else "avtaler" }}            
        strom: "{{states('sensor.norgespris_pris_na') | float(0) | round(2)}}"
        weather: >
          {{ state_attr('sensor.weather_forecast_v2', 'current').condition }} og {{
          state_attr('sensor.weather_forecast_v2', 'current').temperature }}
- sensor:
    - name: "Dashboard office"
      unique_id: dashboard_office
      state: Office
      attributes:
        temp: "{{ states('sensor.office_sensor_temphum_temperature') | round(1)}}"
        strom: "{{ states('sensor.bod_plug_server_power') | round(1)}}"
        uptime: >
          {% set uptime = states('sensor.homeserr_uptime') %}
          {# 1. Split by comma, take the first 2 items, and join them back with a comma and space #}
          {% set short = uptime.split(',')[:2] | join(', ') %}

          {# 2. Translate to Norwegian using a filter chain #}
          {{ short 
            | replace("years", "Ã¥r")
            | replace("year", "Ã¥r")
            | replace("months", "mÃ¥neder")
            | replace("month", "mÃ¥ned")
            | replace("weeks", "uker")
            | replace("week", "uke")
            | replace("days", "dager")
            | replace("day", "dag")
            | replace("hours", "timer")
            | replace("hour", "time")
            | replace("minutes", "minutter")
            | replace("minute", "minutt")
          }}        
- sensor:
    - name: "Dashboard livingroom"
      unique_id: dashboard_livingroom
      state: Stue
      attributes:
        temp: "{{ states('sensor.i_9psl_temperatur') | round(1)}}"
        door: >
          {% if is_state('binary_sensor.livingroom_door_balcony_contact', 'off') %}
          lukket
          {% else %}
          Ã¥pen
          {% endif %}        
        airquality: >
          {% set co2 = states('sensor.i_9psl_karbondioksid') | int(0) %}

          {% if co2 < 600 %}
            veldig braðŸ¤˜
          {% elif co2 < 800 %}
            braðŸ‘ï¸
          {% elif co2 < 1000 %}
            grei
          {% elif co2 < 1200 %}
            okðŸ˜ï¸
          {% elif co2 < 1500 %}
            ikke ideelðŸ˜§
          {% elif co2 < 2000 %}
            ganske dÃ¥rligðŸ‘Žï¸
          {% elif co2 < 3000 %}
            usuntðŸ˜µ
          {% else %}
            veldig usuntðŸ’€
          {% endif %}        
        tvtime: >
          {% set time = states('sensor.tvtid_day') | int(0) %}
          {% set hours = time // 3600 %}
          {% set minutes = (time % 3600) // 60 %}

          {# Define labels based on singular/plural #}
          {% set h_label = 'time' if hours == 1 else 'timer' %}
          {% set m_label = 'minutt' if minutes == 1 else 'minutter' %}

          {# Logic to display the correct format #}
          {% if hours > 0 and minutes > 0 %}
            {{ hours }} {{ h_label }} og {{ minutes }} {{ m_label }}
          {% elif hours > 0 %}
            {{ hours }} {{ h_label }}
          {% else %}
            {{ minutes }} {{ m_label }}
          {% endif %}
        lights_on: >
          {% set target_lights = [
            'light.livingroom_light_bystairs',
            'light.livingroom_light_ceiling_left',
            'light.livingroom_light_ceiling_right',
            'light.livingroom_powerstrip_sofa_l3',
            'light.livingroom_plug_under_trapp'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_on }}        
        lights_off: >
          {% set target_lights = [
            'light.livingroom_light_bystairs',
            'light.livingroom_light_ceiling_left',
            'light.livingroom_light_ceiling_right',
            'light.livingroom_powerstrip_sofa_l3',
            'light.livingroom_plug_under_trapp'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_off }}     
- sensor:
    - name: "Dashboard upstairs"
      unique_id: dashboard_upstairs
      state: Oppe
      attributes:
        temp: "{{ states('sensor.meter_0e9a') | round(1)}}"
        door: >
          {% if is_state('binary_sensor.upstairs_door_balcony_contact', 'off') %}
          lukket
          {% else %}
          Ã¥pen
          {% endif %}        
        airquality: >
          {% set co2 = states('sensor.meter_0e9a_karbondioksid') | int(0) %}

          {% if co2 < 600 %}
            veldig braðŸ¤˜
          {% elif co2 < 800 %}
            braðŸ‘ï¸
          {% elif co2 < 1000 %}
            OKðŸ˜ï¸
          {% elif co2 < 1500 %}
            ikke ideelðŸ˜§
          {% elif co2 < 2000 %}
            ganske dÃ¥rligðŸ‘Žï¸
          {% elif co2 < 3000 %}
            usuntðŸ˜µ
          {% else %}
            veldig usuntðŸ’€
          {% endif %}                
        lights_on: >
          {% set target_lights = [
            'light.upstairs_plug_desklamp',
            'light.upstairs_light_ceilingstairs_dimmerdown',
            'light.upstairs_light_ceiling',
            'light.upstairs_light_nightlight'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_on }}        
        lights_off: >
          {% set target_lights = [
            'light.upstairs_plug_desklamp',
            'light.upstairs_light_ceilingstairs_dimmerdown',
            'light.upstairs_light_ceiling',
            'light.upstairs_light_nightlight'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_off }}     
- sensor:
    - name: "Dashboard kitchen"
      unique_id: dashboard_kitchen
      state: Kjokken
      attributes:
        temp: "{{ states('sensor.kitchen_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.kitchen_sensor_temphum_humidity') | round(1)}}"          
        lights_on: >
          {% set target_lights = [
            'light.kitchen_light_dimmer_left',
            'light.kitchen_light_dimmer_right'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_on }}        
        lights_off: >
          {% set target_lights = [
            'light.kitchen_light_dimmer_left',
            'light.kitchen_light_dimmer_right'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_off }}     
- sensor:
    - name: "Dashboard BathDown"
      unique_id: dashboard_bathdown
      state: Bad nede
      attributes:
        temp: "{{ states('sensor.bathroomdown_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.bathroomdown_sensor_temphum_humidity') | round(1)}}"          
        lights_on: >
          {% set target_lights = [
            'light.light.bathroomdown_light_ceiling'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_on }}        
        lights_off: >
          {% set target_lights = [
            'light.light.bathroomdown_light_ceiling'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_off }}     
- sensor:
    - name: "Dashboard hallway"
      unique_id: dashboard_hallway
      state: Hallway
      attributes:
        temp: "{{ states('sensor.hallway_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.hallway_sensor_temphum_humidity') | round(1)}}"          
        lights_on: >
          {% set target_lights = [
            'light.hallway_light_ceiling',
            'light.outdoor_light_carport'
          ] %}

          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}

          {{ lights_on }}        
        lights_off: >
          {% set target_lights = [
            'light.hallway_light_ceiling',
            'light.outdoor_light_carport'
          ] %}
          {% set lights_on = expand(target_lights) | selectattr('state', 'eq', 'on') | list | count %}
          {% set lights_off = target_lights | count - lights_on %}
          {{ lights_off }}      
        door_lock: >                 
          {{ states('lock.hallway_door_lock') | replace('locked', 'lÃ¥st') | replace('unlocked', 'ulÃ¥st') }}
        door: >
          {% if is_state('binary_sensor.hallway_door_entrance_contact', 'off') %}
          lukket
          {% else %}
          Ã¥pen
          {% endif %}  
- sensor:
    - name: "Dashboard BathUp"
      unique_id: dashboard_bathup
      state: BathUp
      attributes:
        temp: "{{ states('sensor.bathroomup_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.bathroomup_sensor_temphum_humidity') | round(1)}}"          
- sensor:
    - name: "Dashboard Bedroom"
      unique_id: dashboard_bedroom
      state: Bedroom
      attributes:
        temp: "{{ states('sensor.bedroom_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.bedroom_sensor_temphum_humidity') | round(1)}}"  
- sensor:
    - name: "Dashboard Tina"
      unique_id: dashboard_Tina
      state: Tina
      attributes:
        temp: "{{ states('sensor.Tina_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.Tina_sensor_temphum_humidity') | round(1)}}"  
- sensor:
    - name: "Dashboard Anna"
      unique_id: dashboard_Anna
      state: Anna
      attributes:
        temp: "{{ states('sensor.Anna_sensor_temphum_temperature') | round(1)}}"
        hum: "{{ states('sensor.Anna_sensor_temphum_humidity') | round(1)}}"          
